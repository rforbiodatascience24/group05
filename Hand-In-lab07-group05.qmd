---
title: "Lab 7 Assignment: Group 05"
subtitle: 'Students: s243284, s242872,	s243302,	s243547,	s243360'
format:
  html:
    embed-resources: true
editor: visual
---

# Lab 07 Group Assignment

Miguel Blanco Chillerón, s243284

Daniel Gil Conejo, 242872

Luis Martín del Cerro, s243302

Natalia Feced Garcia, s243547

Xavier Chapatte Banaset, s243360

## Load Libraries

```{r}
library(tidyverse)
library(broom)
library(cowplot)
```

## Data

```{r}
target_url <- "https://github.com/ramhiser/datamicroarray/raw/master/data/gravier.RData"
output_file <- "data/gravier.RData"
curl::curl_download(url = target_url, destfile = output_file)
```

```{r}
load(file = "data/gravier.RData")
```

We will use the info and code from <https://clauswilke.com/blog/2020/09/07/pca-tidyverse-style/> to perform a PCA usind the tidyverse with the gravier data. First thing to notice is that gravier data is muhc bigger than the one used on the page, so the visualization of our PCA sometimes is completely useless, just for the sake of learning with github.

## PCA Data Coordinates

```{r}
set.seed(676571)
cancer_data=mutate(as_tibble(pluck(gravier,"x")),y=pluck(gravier,"y"),pt_id=1:length(pluck(gravier, "y")),age=round(rnorm(length(pluck(gravier,"y")),mean=55,sd=10),1))
cancer_data=rename(cancer_data,event_label=y)
cancer_data$age_group=cut(cancer_data$age,breaks=seq(10,100,by=10))
cancer_data=relocate(cancer_data,c(pt_id,age,age_group,pt_id,event_label))

pca_fit <- cancer_data |> 
  select(where(is.numeric)) |> 
  prcomp(scale = TRUE)

pca_fit |>
  augment(cancer_data) |> # add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, color = event_label)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c(good = "#D55E00", poor = "#0072B2")
  ) +
  theme_half_open(12) + background_grid() 
  
```

## Rotation Matrix

```{r}
pca_fit |>
  tidy(matrix = "rotation")
# define arrow style for plotting
arrow_style <- arrow(
  angle = 20, ends = "first", type = "closed", length = grid::unit(8, "pt")
)

# plot rotation matrix
pca_fit |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") |>
  ggplot(aes(PC1, PC2)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
  geom_text(
    aes(label = column),
    hjust = 1, nudge_x = -0.02, 
    color = "#904C2F"
  ) +
  xlim(-1.25, .5) + ylim(-.5, 1) +
  coord_fixed() + # fix aspect ratio to 1:1
  theme_minimal_grid(12)
```

## Variance explained by PC

```{r}
pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#56B4E9", alpha = 0.8) +
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  scale_x_continuous(limits = c(0, 30)) +
  theme_minimal_hgrid(12)
```
